<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a73e8">
    <title>Gasolineras Cercanas</title>
    <link rel="manifest" href="manifest.webmanifest">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            padding-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 20px 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #334155;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 16px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        label {
            font-size: 13px;
            font-weight: 500;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input, button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        select, input {
            background: #1e293b;
            color: #f1f5f9;
            flex: 1;
            min-width: 100px;
            border: 1px solid #334155;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button {
            background: #10b981;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 44px;
            min-height: 44px;
            border-radius: 12px;
        }

        button:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #334155;
            cursor: not-allowed;
            transform: none;
        }

        .range-toggle {
            display: flex;
            background: #1e293b;
            border-radius: 24px;
            overflow: hidden;
            position: relative;
            border: 1px solid #334155;
            padding: 4px;
        }

        .range-toggle-indicator {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(50% - 4px);
            height: calc(100% - 8px);
            background: #3b82f6;
            border-radius: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .range-toggle-indicator.mode-min {
            transform: translateX(calc(100% + 4px));
        }

        .range-toggle button {
            flex: 1;
            background: transparent;
            color: #94a3b8;
            border-radius: 20px;
            min-width: 70px;
            position: relative;
            z-index: 1;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .range-toggle button:hover {
            transform: none;
            box-shadow: none;
        }

        .range-toggle button.active {
            color: white;
            font-weight: 600;
        }

        .liters-presets {
            display: flex;
            gap: 6px;
        }

        .liters-presets button {
            flex: 1;
            background: #1e293b;
            color: #94a3b8;
            border: 1px solid #334155;
            min-width: 50px;
            font-size: 13px;
        }

        .liters-presets button:hover {
            background: #334155;
            color: #f1f5f9;
            border-color: #3b82f6;
        }

        .advanced {
            background: rgba(30, 41, 59, 0.5);
            padding: 12px;
            border-radius: 12px;
            margin-top: 8px;
            border: 1px solid #334155;
        }

        .advanced-toggle {
            background: transparent;
            color: #94a3b8;
            text-decoration: none;
            padding: 8px;
            font-size: 13px;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .advanced-toggle:hover {
            color: #3b82f6;
            transform: none;
            box-shadow: none;
        }

        .advanced-content {
            display: none;
            margin-top: 12px;
            gap: 10px;
            animation: slideDown 0.3s ease;
        }

        .advanced-content.show {
            display: flex;
            flex-direction: column;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status {
            padding: 14px 16px;
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid #fbbf24;
            margin: 16px;
            border-radius: 8px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }

        .status.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
        }

        .station-list {
            padding: 0 16px;
        }

        .station-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border: 1px solid #334155;
            transition: all 0.3s ease;
            animation: fadeInUp 0.4s ease backwards;
        }

        .station-card:nth-child(1) { animation-delay: 0.05s; }
        .station-card:nth-child(2) { animation-delay: 0.1s; }
        .station-card:nth-child(3) { animation-delay: 0.15s; }
        .station-card:nth-child(4) { animation-delay: 0.2s; }
        .station-card:nth-child(5) { animation-delay: 0.25s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .station-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            border-color: #3b82f6;
        }

        .station-card.best {
            border: 2px solid #10b981;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
            background: linear-gradient(135deg, #1e293b 0%, #1a3a2e 100%);
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .station-name {
            font-weight: 600;
            font-size: 17px;
            flex: 1;
            color: #f1f5f9;
        }

        .station-rank {
            background: #3b82f6;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .station-rank.best {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .station-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 14px 0;
            font-size: 14px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            color: #94a3b8;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .info-value {
            font-weight: 700;
            font-size: 17px;
            color: #f1f5f9;
        }

        .total-cost {
            background: rgba(59, 130, 246, 0.1);
            padding: 14px;
            border-radius: 12px;
            margin: 14px 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .total-cost-value {
            font-size: 24px;
            font-weight: 800;
            color: #3b82f6;
            text-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .cost-breakdown {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 6px;
            line-height: 1.5;
        }

        .crossover-info {
            background: rgba(251, 191, 36, 0.1);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 10px;
            border-left: 3px solid #fbbf24;
            color: #fbbf24;
            line-height: 1.4;
        }

        .station-actions {
            display: flex;
            gap: 8px;
            margin-top: 14px;
        }

        .btn-nav {
            flex: 1;
            background: #3b82f6;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-nav:hover {
            background: #2563eb;
        }

        .sort-controls {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #1e293b;
            margin: 16px 16px 0 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border: 1px solid #334155;
        }

        .sort-controls button {
            flex: 1;
            background: transparent;
            color: #94a3b8;
            border: 1px solid #334155;
            font-size: 13px;
            font-weight: 500;
        }

        .sort-controls button:hover {
            background: #334155;
            color: #f1f5f9;
            transform: none;
        }

        .sort-controls button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }

        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .refresh-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99;
            border: 1px solid rgba(59, 130, 246, 0.5);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            width: 52px;
            height: 52px;
            background: rgba(59, 130, 246, 1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚õΩ Gasolineras Cercanas</h1>
        
        <div class="controls">
            <div class="control-row">
                <label>Combustible:</label>
                <select id="fuelType">
                    <option value="sp95">Gasolina 95</option>
                    <option value="sp98">Gasolina 98</option>
                    <option value="diesel">Di√©sel</option>
                </select>
                <button onclick="enableRealRoutes()" style="background: #9c27b0; min-width: auto; padding: 8px 12px; font-size: 12px;" title="Habilitar rutas precisas con c√≥digo">üîê</button>
            </div>

            <div class="control-row">
                <label>Rango:</label>
                <div class="range-toggle">
                    <div class="range-toggle-indicator" id="rangeIndicator"></div>
                    <button id="rangeModeKm" class="active">Km</button>
                    <button id="rangeModeMin">Min</button>
                </div>
                <input type="number" id="rangeValue" value="10" min="1" max="50">
            </div>

            <div class="control-row">
                <label>Litros:</label>
                <input type="number" id="litersX" value="30" min="1" max="100" style="max-width: 80px;">
                <div class="liters-presets">
                    <button onclick="setLiters(15)">15L</button>
                    <button onclick="setLiters(30)">30L</button>
                    <button onclick="setLiters(50)">50L</button>
                </div>
            </div>

            <div class="advanced">
                <button class="advanced-toggle" onclick="toggleAdvanced()">‚öôÔ∏è Opciones avanzadas</button>
                <div class="advanced-content" id="advancedContent">
                    <div class="control-row">
                        <label>Consumo (L/100km):</label>
                        <input type="number" id="consumptionC" value="4.5" min="3" max="20" step="0.1">
                    </div>
                    <div class="control-row">
                        <label>Valor tiempo (‚Ç¨/h):</label>
                        <input type="number" id="timeValueV" value="0" min="0" max="50" step="1">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="statusBar"></div>

    <div class="sort-controls" id="sortControls" style="display: none;">
        <button id="sortCost" class="active">Coste Total</button>
        <button id="sortPrice">Precio</button>
        <button id="sortTime">Tiempo</button>
    </div>

    <div class="station-list" id="stationList"></div>

    <button class="refresh-btn" id="refreshBtn" onclick="init()">üîÑ</button>

    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const CONFIG = {
            // API de precios del Ministerio (datos abiertos)
            PRICES_API: 'https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/',

            // Google Maps API (REEMPLAZAR CON TU CLAVE)
            GOOGLE_API_KEY: 'TU_GOOGLE_MAPS_API_KEY',
            DISTANCE_MATRIX_API: 'https://maps.googleapis.com/maps/api/distancematrix/json'
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let allStations = [];
        let paretoData = null; // NUEVO: datos de frontera de Pareto
        let userLocation = null;

        // ============================================
        // UTILIDADES
        // ============================================
        function showMessage(msg, type = 'info') {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="message message-${type}">${msg}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function getDistanceMatrix(origins, destinations) {
            if (!CONFIG.GOOGLE_API_KEY || CONFIG.GOOGLE_API_KEY === 'TU_GOOGLE_MAPS_API_KEY') {
                return null;
            }

            try {
                const originsStr = origins.map(o => `${o.lat},${o.lng}`).join('|');
                const destinationsStr = destinations.map(d => `${d.lat},${d.lng}`).join('|');

                const url = `${CONFIG.DISTANCE_MATRIX_API}?origins=${originsStr}&destinations=${destinationsStr}&mode=driving&key=${CONFIG.GOOGLE_API_KEY}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'OK') {
                    return data.rows;
                }
            } catch (error) {
                console.warn('Error al obtener distancias de Google Maps:', error);
            }

            return null;
        }

        // ============================================
        // NUEVO: C√ÅLCULO DE FRONTERA DE PARETO
        // ============================================
        function calculateDetourCost(station, fuelConsumptionPerKm, userFuelPrice, timeValueEurPerMin) {
            // Coste del combustible del desv√≠o (ida y vuelta)
            const fuelCost = station.distanceKm * 2 * fuelConsumptionPerKm * userFuelPrice;

            // Coste del tiempo del desv√≠o (ida y vuelta)  
            const timeCost = station.timeMin * 2 * timeValueEurPerMin;

            // Coste total del desv√≠o
            return fuelCost + timeCost;
        }

        function calculateParetoFrontier(stations) {
            if (stations.length === 0) return { frontier: [], dominated: [], crossovers: [] };
            if (stations.length === 1) {
                stations[0].inFrontier = true;
                stations[0].rangeStart = 0;
                stations[0].rangeEnd = Infinity;
                stations[0].rangeText = "cualquier cantidad";
                return { frontier: [stations[0]], dominated: [], crossovers: [] };
            }

            // Paso 1: Identificar gasolineras dominadas
            const dominated = [];
            const frontier = [];

            stations.forEach((st, i) => {
                let isDominated = false;

                for (let j = 0; j < stations.length; j++) {
                    if (i === j) continue;

                    const other = stations[j];
                    // Una gasolinera domina si es igual o mejor en precio Y igual o menor en coste de desv√≠o
                    if (other.precioProducto <= st.precioProducto && 
                        other.detourCostEur <= st.detourCostEur &&
                        (other.precioProducto < st.precioProducto || other.detourCostEur < st.detourCostEur)) {
                        isDominated = true;
                        break;
                    }
                }

                if (isDominated) {
                    dominated.push(st);
                    st.inFrontier = false;
                } else {
                    frontier.push(st);
                    st.inFrontier = true;
                }
            });

            // Paso 2: Ordenar frontera por precio creciente
            frontier.sort((a, b) => a.precioProducto - b.precioProducto);

            // Paso 3: Calcular puntos de cruce entre gasolineras consecutivas
            const crossovers = [];
            for (let i = 0; i < frontier.length - 1; i++) {
                const current = frontier[i];
                const next = frontier[i + 1];

                const m1 = current.precioProducto;
                const m2 = next.precioProducto;
                const n1 = current.detourCostEur;
                const n2 = next.detourCostEur;

                const priceDiff = m2 - m1;
                const costDiff = n1 - n2;

                if (Math.abs(priceDiff) > 0.0001) {
                    const crossoverLiters = costDiff / priceDiff;
                    crossovers.push({
                        station1: current,
                        station2: next,
                        liters: crossoverLiters
                    });
                }
            }

            // Paso 4: Asignar rangos de dominancia
            if (frontier.length > 0) {
                if (frontier.length === 1) {
                    frontier[0].rangeStart = 0;
                    frontier[0].rangeEnd = Infinity;
                    frontier[0].rangeText = "cualquier cantidad";
                } else {
                    for (let i = 0; i < frontier.length; i++) {
                        if (i === 0) {
                            // La m√°s barata
                            frontier[i].rangeStart = crossovers[0].liters > 0 ? crossovers[0].liters : 0;
                            frontier[i].rangeEnd = Infinity;
                            if (frontier[i].rangeStart > 100) {
                                frontier[i].rangeText = `repostajes muy grandes (>${frontier[i].rangeStart.toFixed(0)} L)`;
                            } else {
                                frontier[i].rangeText = `m√°s de ${frontier[i].rangeStart.toFixed(1)} L`;
                            }
                        } else if (i === frontier.length - 1) {
                            // La m√°s cara
                            frontier[i].rangeStart = 0;
                            frontier[i].rangeEnd = crossovers[i - 1].liters > 0 ? crossovers[i - 1].liters : Infinity;
                            frontier[i].rangeText = `menos de ${frontier[i].rangeEnd.toFixed(1)} L`;
                        } else {
                            // Intermedias
                            frontier[i].rangeStart = crossovers[i].liters > 0 ? crossovers[i].liters : 0;
                            frontier[i].rangeEnd = crossovers[i - 1].liters > 0 ? crossovers[i - 1].liters : Infinity;
                            frontier[i].rangeText = `entre ${frontier[i].rangeStart.toFixed(1)} y ${frontier[i].rangeEnd.toFixed(1)} L`;
                        }
                    }
                }
            }

            // Marcar dominadas
            dominated.forEach(st => {
                st.rangeStart = null;
                st.rangeEnd = null;
                st.rangeText = "nunca es √≥ptima";
            });

            return { frontier, dominated, crossovers };
        }

        function updateDetourCosts() {
            const fuelConsumption = parseFloat(document.getElementById('consumo').value) / 100 || 0.06;
            const userFuelPrice = parseFloat(document.getElementById('precioActual').value) || 1.50;
            const timeValue = parseFloat(document.getElementById('valorTiempo').value) || 0;

            allStations.forEach(st => {
                st.detourCostEur = calculateDetourCost(st, fuelConsumption, userFuelPrice, timeValue);
            });
        }

        // ============================================
        // BUSCAR GASOLINERAS
        // ============================================
        async function fetchStations() {
            const btnBuscar = document.getElementById('btnBuscar');
            const loading = document.getElementById('loading');
            const resultados = document.getElementById('resultados');

            btnBuscar.disabled = true;
            btnBuscar.textContent = '‚è≥ Buscando...';
            loading.style.display = 'block';
            resultados.innerHTML = '';

            try {
                // Obtener ubicaci√≥n
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 30000
                    });
                });

                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Obtener par√°metros
                const radio = parseFloat(document.getElementById('radio').value);
                const tipoCombustible = document.getElementById('tipoCombustible').value;

                // Consultar API
                const response = await fetch(CONFIG.PRICES_API);
                const data = await response.json();

                if (!data.ListaEESSPrecio || data.ListaEESSPrecio.length === 0) {
                    showMessage('No se encontraron datos de gasolineras', 'error');
                    return;
                }

                // Procesar y filtrar estaciones
                const precioField = `Precio ${tipoCombustible}`;
                allStations = data.ListaEESSPrecio
                    .map(station => {
                        const lat = parseFloat(station.Latitud.replace(',', '.'));
                        const lon = parseFloat(station['Longitud (WGS84)'].replace(',', '.'));
                        const precio = parseFloat((station[precioField] || '0').replace(',', '.'));

                        if (isNaN(precio) || precio === 0 || isNaN(lat) || isNaN(lon)) return null;

                        const distanceKm = haversineDistance(userLocation.lat, userLocation.lng, lat, lon);

                        if (distanceKm > radio) return null;

                        return {
                            id: station['IDEESS'],
                            nombre: station['R√≥tulo'] || 'Sin nombre',
                            direccion: station['Direcci√≥n'] || '',
                            municipio: station['Municipio'] || '',
                            provincia: station['Provincia'] || '',
                            precioProducto: precio,
                            lat,
                            lon,
                            distanceKm,
                            timeMin: distanceKm * 2, // Estimaci√≥n: 2 min/km
                            horario: station['Horario'] || 'No disponible',
                            detourCostEur: 0
                        };
                    })
                    .filter(st => st !== null);

                if (allStations.length === 0) {
                    showMessage('No se encontraron gasolineras con ese combustible en el radio especificado', 'warning');
                    return;
                }

                showMessage(`‚úì Encontradas ${allStations.length} gasolineras`, 'success');

                // Calcular costes de desv√≠o
                updateDetourCosts();

                // Calcular frontera de Pareto
                paretoData = calculateParetoFrontier(allStations);

                // Renderizar
                renderStations();

            } catch (error) {
                console.error('Error:', error);
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                btnBuscar.disabled = false;
                btnBuscar.textContent = 'üîç Buscar Gasolineras';
                loading.style.display = 'none';
            }
        }

        // ============================================
        // RENDERIZAR GASOLINERAS
        // ============================================
        function renderStations() {
            const resultados = document.getElementById('resultados');
            const litrosValue = document.getElementById('litrosRepostar').value;
            const ordenar = document.getElementById('ordenar').value;

            const litros = litrosValue === 'user' ? null : parseFloat(litrosValue);

            // Calcular coste total
            allStations.forEach(st => {
                if (litros !== null) {
                    st.totalCostEur = st.precioProducto * litros + st.detourCostEur;

                    // Determinar si es √≥ptima para esta cantidad
                    if (st.inFrontier) {
                        st.isOptimalForCurrent = (litros >= st.rangeStart && litros < st.rangeEnd);
                    } else {
                        st.isOptimalForCurrent = false;
                    }
                } else {
                    st.isOptimalForCurrent = false;
                }
            });

            // Ordenar estaciones
            let sortedStations = [...allStations];

            if (ordenar === 'recomendado' && paretoData) {
                // Ordenaci√≥n inteligente
                const optimal = sortedStations.filter(st => st.isOptimalForCurrent);
                const frontierOthers = sortedStations.filter(st => st.inFrontier && !st.isOptimalForCurrent);
                const dominated = sortedStations.filter(st => !st.inFrontier);

                frontierOthers.sort((a, b) => a.rangeStart - b.rangeStart);
                dominated.sort((a, b) => a.distanceKm - b.distanceKm);

                sortedStations = [...optimal, ...frontierOthers, ...dominated];
            } else if (ordenar === 'precio') {
                sortedStations.sort((a, b) => a.precioProducto - b.precioProducto);
            } else if (ordenar === 'tiempo') {
                sortedStations.sort((a, b) => a.timeMin - b.timeMin);
            } else if (ordenar === 'coste' && litros !== null) {
                sortedStations.sort((a, b) => a.totalCostEur - b.totalCostEur);
            }

            // Renderizar HTML
            let html = '';

            sortedStations.forEach((st, index) => {
                const userFuelPrice = parseFloat(document.getElementById('precioActual').value) || 1.50;
                const priceDiff = userFuelPrice - st.precioProducto;
                const detourCostEur = st.detourCostEur;

                // Determinar texto del badge
                let badgeText = '';
                let badgeColor = '';

                if (st.isOptimalForCurrent && litros !== null) {
                    badgeText = `‚≠ê Mejor opci√≥n para ${litros} L`;
                    badgeColor = 'background: #2e7d32;';
                } else if (st.inFrontier) {
                    badgeText = `Mejor para ${st.rangeText}`;
                    badgeColor = 'background: #42a5f5;';
                } else {
                    badgeText = 'No recomendada';
                    badgeColor = 'background: #ef5350;';
                }

                html += `
                    <div class="station-card" style="${!st.inFrontier ? 'opacity: 0.7; border-left: 4px solid #ef5350;' : st.isOptimalForCurrent ? 'border-left: 4px solid #2e7d32;' : 'border-left: 4px solid #42a5f5;'}">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <h3 style="margin:0 0 8px; font-size:1.1rem; color:#f8fafc;">${st.nombre}</h3>
                                <p style="font-size:0.85rem; color:#94a3b8; margin:4px 0;">${st.direccion}</p>
                                <p style="font-size:0.85rem; color:#94a3b8;">${st.municipio}</p>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:1.5rem; font-weight:700; color:#60a5fa;">${st.precioProducto.toFixed(3)} ‚Ç¨/L</div>
                                <div style="font-size:0.75rem; color:#94a3b8;">${st.distanceKm.toFixed(1)} km ¬∑ ${st.timeMin.toFixed(0)} min</div>
                            </div>
                        </div>

                        <div style="margin: 12px 0; padding: 8px 12px; border-radius: 6px; ${badgeColor} color: white; font-size: 0.85rem; font-weight: 600;">
                            ${badgeText}
                        </div>

                        ${litros !== null ? `
                            <p style="font-size:0.85rem; color:#cbd5e1; margin:6px 0;">
                                üí∞ Coste total (${litros} L): <strong>${st.totalCostEur.toFixed(2)} ‚Ç¨</strong>
                            </p>
                            <p style="font-size:0.85rem; color:#cbd5e1; margin:4px 0;">
                                ‚õΩ Coste combustible: ${(st.precioProducto * litros).toFixed(2)} ‚Ç¨ ¬∑ 
                                üöó Desv√≠o: ${detourCostEur.toFixed(2)} ‚Ç¨
                            </p>
                        ` : ''}

                        <p style="font-size:0.85rem; color:#cbd5e1; margin:4px 0;">
                            Esta estaci√≥n es ${priceDiff > 0 ? 'm√°s barata' : 'm√°s cara'}: 
                            ${Math.abs(priceDiff).toFixed(3)}‚Ç¨/L${st.inFrontier ? '' : ' pero hay mejores opciones'}
                        </p>

                        <button onclick="navigateTo(${st.lat}, ${st.lon})" 
                                style="width:100%; margin-top:12px; padding:12px; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:0.95rem;">
                            üß≠ Navegar
                        </button>
                    </div>
                `;
            });

            resultados.innerHTML = html;
        }

        function navigateTo(lat, lon) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
            window.open(url, '_blank');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Listener para cambios en litros
            document.getElementById('litrosRepostar').addEventListener('change', function() {
                if (allStations.length > 0) {
                    renderStations();
                }
            });

            // Listener para ordenaci√≥n
            document.getElementById('ordenar').addEventListener('change', function() {
                if (allStations.length > 0) {
                    renderStations();
                }
            });

            // Listeners para par√°metros avanzados
            document.getElementById('valorTiempo').addEventListener('input', function() {
                if (allStations.length > 0) {
                    updateDetourCosts();
                    paretoData = calculateParetoFrontier(allStations);
                    renderStations();
                }
            });

            document.getElementById('consumo').addEventListener('input', function() {
                if (allStations.length > 0) {
                    updateDetourCosts();
                    paretoData = calculateParetoFrontier(allStations);
                    renderStations();
                }
            });

            document.getElementById('precioActual').addEventListener('input', function() {
                if (allStations.length > 0) {
                    updateDetourCosts();
                    paretoData = calculateParetoFrontier(allStations);
                    renderStations();
                }
            });
        });

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registrado'))
                .catch(err => console.log('Error SW:', err));
        }
    </script>
</body>
</html>
