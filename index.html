<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a73e8">
    <title>Gasolineras Cercanas</title>
    <link rel="manifest" href="manifest.webmanifest">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            padding-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 20px 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #334155;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 16px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        label {
            font-size: 13px;
            font-weight: 500;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input, button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        select, input {
            background: #1e293b;
            color: #f1f5f9;
            flex: 1;
            min-width: 100px;
            border: 1px solid #334155;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button {
            background: #10b981;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 44px;
            min-height: 44px;
            border-radius: 12px;
        }

        button:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #334155;
            cursor: not-allowed;
            transform: none;
        }

        .range-toggle {
            display: flex;
            background: #1e293b;
            border-radius: 24px;
            overflow: hidden;
            position: relative;
            border: 1px solid #334155;
            padding: 4px;
        }

        .range-toggle-indicator {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(50% - 4px);
            height: calc(100% - 8px);
            background: #3b82f6;
            border-radius: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .range-toggle-indicator.mode-min {
            transform: translateX(calc(100% + 4px));
        }

        .range-toggle button {
            flex: 1;
            background: transparent;
            color: #94a3b8;
            border-radius: 20px;
            min-width: 70px;
            position: relative;
            z-index: 1;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .range-toggle button:hover {
            transform: none;
            box-shadow: none;
        }

        .range-toggle button.active {
            color: white;
            font-weight: 600;
        }

        .liters-presets {
            display: flex;
            gap: 6px;
        }

        .liters-presets button {
            flex: 1;
            background: #1e293b;
            color: #94a3b8;
            border: 1px solid #334155;
            min-width: 50px;
            font-size: 13px;
        }

        .liters-presets button:hover {
            background: #334155;
            color: #f1f5f9;
            border-color: #3b82f6;
        }

        .advanced {
            background: rgba(30, 41, 59, 0.5);
            padding: 12px;
            border-radius: 12px;
            margin-top: 8px;
            border: 1px solid #334155;
        }

        .advanced-toggle {
            background: transparent;
            color: #94a3b8;
            text-decoration: none;
            padding: 8px;
            font-size: 13px;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .advanced-toggle:hover {
            color: #3b82f6;
            transform: none;
            box-shadow: none;
        }

        .advanced-content {
            display: none;
            margin-top: 12px;
            gap: 10px;
            animation: slideDown 0.3s ease;
        }

        .advanced-content.show {
            display: flex;
            flex-direction: column;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status {
            padding: 14px 16px;
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid #fbbf24;
            margin: 16px;
            border-radius: 8px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }

        .status.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
        }

        .station-list {
            padding: 0 16px;
        }

        .station-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border: 1px solid #334155;
            transition: all 0.3s ease;
            animation: fadeInUp 0.4s ease backwards;
        }

        .station-card:nth-child(1) { animation-delay: 0.05s; }
        .station-card:nth-child(2) { animation-delay: 0.1s; }
        .station-card:nth-child(3) { animation-delay: 0.15s; }
        .station-card:nth-child(4) { animation-delay: 0.2s; }
        .station-card:nth-child(5) { animation-delay: 0.25s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .station-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            border-color: #3b82f6;
        }

        .station-card.best {
            border: 2px solid #10b981;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
            background: linear-gradient(135deg, #1e293b 0%, #1a3a2e 100%);
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .station-name {
            font-weight: 600;
            font-size: 17px;
            flex: 1;
            color: #f1f5f9;
        }

        .station-rank {
            background: #3b82f6;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .station-rank.best {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .station-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 14px 0;
            font-size: 14px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            color: #94a3b8;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .info-value {
            font-weight: 700;
            font-size: 17px;
            color: #f1f5f9;
        }

        .total-cost {
            background: rgba(59, 130, 246, 0.1);
            padding: 14px;
            border-radius: 12px;
            margin: 14px 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .total-cost-value {
            font-size: 24px;
            font-weight: 800;
            color: #3b82f6;
            text-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .cost-breakdown {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 6px;
            line-height: 1.5;
        }

        .crossover-info {
            background: rgba(251, 191, 36, 0.1);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 10px;
            border-left: 3px solid #fbbf24;
            color: #fbbf24;
            line-height: 1.4;
        }

        .station-actions {
            display: flex;
            gap: 8px;
            margin-top: 14px;
        }

        .btn-nav {
            flex: 1;
            background: #3b82f6;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-nav:hover {
            background: #2563eb;
        }

        .sort-controls {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #1e293b;
            margin: 16px 16px 0 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border: 1px solid #334155;
        }

        .sort-controls button {
            flex: 1;
            background: transparent;
            color: #94a3b8;
            border: 1px solid #334155;
            font-size: 13px;
            font-weight: 500;
        }

        .sort-controls button:hover {
            background: #334155;
            color: #f1f5f9;
            transform: none;
        }

        .sort-controls button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }

        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .refresh-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99;
            border: 1px solid rgba(59, 130, 246, 0.5);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            width: 52px;
            height: 52px;
            background: rgba(59, 130, 246, 1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚õΩ Gasolineras Cercanas</h1>
        
        <div class="controls">
            <div class="control-row">
                <label>Combustible:</label>
                <select id="fuelType">
                    <option value="sp95">Gasolina 95</option>
                    <option value="sp98">Gasolina 98</option>
                    <option value="diesel">Di√©sel</option>
                </select>
                <button onclick="enableRealRoutes()" style="background: #9c27b0; min-width: auto; padding: 8px 12px; font-size: 12px;" title="Habilitar rutas precisas con c√≥digo">üîê</button>
            </div>

            <div class="control-row">
                <label>Rango:</label>
                <div class="range-toggle">
                    <div class="range-toggle-indicator" id="rangeIndicator"></div>
                    <button id="rangeModeKm" class="active">Km</button>
                    <button id="rangeModeMin">Min</button>
                </div>
                <input type="number" id="rangeValue" value="10" min="1" max="50">
            </div>

            <div class="control-row">
                <label>Litros:</label>
                <input type="number" id="litersX" value="30" min="1" max="100" style="max-width: 80px;">
                <div class="liters-presets">
                    <button onclick="setLiters(15)">15L</button>
                    <button onclick="setLiters(30)">30L</button>
                    <button onclick="setLiters(50)">50L</button>
                </div>
            </div>

            <div class="advanced">
                <button class="advanced-toggle" onclick="toggleAdvanced()">‚öôÔ∏è Opciones avanzadas</button>
                <div class="advanced-content" id="advancedContent">
                    <div class="control-row">
                        <label>Consumo (L/100km):</label>
                        <input type="number" id="consumptionC" value="4.5" min="3" max="20" step="0.1">
                    </div>
                    <div class="control-row">
                        <label>Valor tiempo (‚Ç¨/h):</label>
                        <input type="number" id="timeValueV" value="0" min="0" max="50" step="1">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="statusBar"></div>

    <div class="sort-controls" id="sortControls" style="display: none;">
        <button id="sortCost" class="active">‚≠ê Recomendada</button>
        <button id="sortPrice">üí∞ Precio</button>
        <button id="sortTime">‚è±Ô∏è Tiempo</button>
    </div>

    <div class="station-list" id="stationList"></div>

    <button class="refresh-btn" id="refreshBtn" onclick="init()">üîÑ</button>

    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const CONFIG = {
            // API de precios del Ministerio (datos abiertos)
            PRICES_API: 'https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/',
            
            // Google Maps API (REEMPLAZAR CON TU CLAVE)
            GOOGLE_API_KEY: 'TU_GOOGLE_MAPS_API_KEY',
            DISTANCE_MATRIX_API: 'https://maps.googleapis.com/maps/api/distancematrix/json',
            
            // Hash SHA-256 del c√≥digo secreto (no el c√≥digo en s√≠)
            // Para generar tu hash: abre consola y escribe: await hashCode('tuCodigoSecreto')
            SECRET_HASH: 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855', // Hash de "miCodigo123"
            
            // L√≠mites de b√∫squeda
            MAX_STATIONS: 50,
            BATCH_SIZE: 25, // Google permite 25 destinos por llamada
            
            // Radio de b√∫squeda inicial para modo minutos
            INITIAL_RADIUS_KM: 10,
            MAX_RADIUS_KM: 50,
            
            // Defaults
            DEFAULTS: {
                fuelType: 'sp95',
                rangeMode: 'km',
                rangeValue: 10,
                litersX: 30,
                consumptionC: 4.5,
                timeValueV: 0
            }
        };

        // Variable global para almacenar datos de Pareto
        let paretoData = null;

        // ============================================
        // ESTADO GLOBAL
        // ============================================
        let state = {
            location: null,
            fuelType: CONFIG.DEFAULTS.fuelType,
            rangeMode: CONFIG.DEFAULTS.rangeMode,
            rangeValue: CONFIG.DEFAULTS.rangeValue,
            litersX: CONFIG.DEFAULTS.litersX,
            consumptionC: CONFIG.DEFAULTS.consumptionC,
            timeValueV: CONFIG.DEFAULTS.timeValueV,
            stations: [],
            enrichedStations: [],
            sortBy: 'cost',
            loading: false,
            error: null,
            useRealRoutes: false // Por defecto usa geod√©sica
        };

        // Verificar si hay c√≥digo secreto guardado
        async function checkSecretCode() {
            const savedHash = localStorage.getItem('apiAccessHash');
            if (savedHash === CONFIG.SECRET_HASH) {
                state.useRealRoutes = true;
                console.log('‚úÖ Acceso a API de rutas habilitado');
            }
        }

        // Generar hash SHA-256 de un texto
        async function hashCode(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Funci√≥n para activar API (solo para ti)
        async function enableRealRoutes() {
            const code = prompt('üîê C√≥digo de acceso para rutas precisas:');
            if (code === null) return; // Usuario cancel√≥
            
            const inputHash = await hashCode(code);
            
            if (inputHash === CONFIG.SECRET_HASH) {
                localStorage.setItem('apiAccessHash', inputHash);
                state.useRealRoutes = true;
                showStatus('‚úÖ Rutas precisas habilitadas permanentemente', 'success');
                setTimeout(() => init(), 1500);
            } else {
                showStatus('‚ùå C√≥digo incorrecto', 'error');
            }
        }

        // Verificar c√≥digo al cargar
        checkSecretCode();

        // ============================================
        // ALGORITMO DE FRONTERA DE PARETO
        // ============================================

        /**
         * Calcula el coste del desv√≠o a una gasolinera (ida + vuelta)
         * @param {Object} station - Objeto gasolinera con distanceKm y durationMin
         * @param {number} fuelConsumptionPerKm - Consumo en L/km (consumo/100)
         * @param {number} userFuelPrice - Precio actual del usuario en ‚Ç¨/L
         * @param {number} timeValueEurPerMin - Valor del tiempo en ‚Ç¨/min
         * @returns {number} Coste total del desv√≠o en euros
         */
        function calculateDetourCost(station, fuelConsumptionPerKm, userFuelPrice, timeValueEurPerMin) {
            const fuelCost = station.distanceKm * 2 * fuelConsumptionPerKm * userFuelPrice;
            const timeCost = station.durationMin * 2 * timeValueEurPerMin;
            return fuelCost 