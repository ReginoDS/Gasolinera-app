<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Consulta precios de gasolineras en Espa√±a">
    <title>Gasolineras Espa√±a</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        .search-box {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .search-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .info-text {
            font-size: 14px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee;
            border-left: 4px solid #c33;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .results-header {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .gas-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .gas-card h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .gas-address {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .price-box {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .price-box.g95 { background: #e8f5e9; }
        .price-box.g98 { background: #e3f2fd; }
        .price-box.diesel { background: #fff3e0; }
        .price-box.diesel-plus { background: #f3e5f5; }
        
        .price-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .price-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .g95 .price-value { color: #2e7d32; }
        .g98 .price-value { color: #1565c0; }
        .diesel .price-value { color: #e65100; }
        .diesel-plus .price-value { color: #6a1b9a; }
        
        .schedule {
            font-size: 12px;
            color: #999;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚õΩ Gasolineras en Espa√±a</h1>
            <p>Precios oficiales del Ministerio para la Transici√≥n Ecol√≥gica</p>
        </div>

        <div class="search-box">
            <div class="search-group">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Buscar por municipio (ej: Madrid, Barcelona, Valencia...)"
                >
                <button onclick="buscarGasolineras()" id="searchBtn">Buscar</button>
            </div>
            <p class="info-text" id="infoText">
                Introduce un municipio para ver las gasolineras disponibles
            </p>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Cargando datos del Ministerio...</p>
        </div>

        <div id="error" style="display: none;"></div>

        <div id="results"></div>
    </div>

    <script>
        let todasLasGasolineras = [];

        // Permitir buscar con Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarGasolineras();
            }
        });

        async function buscarGasolineras() {
            const busqueda = document.getElementById('searchInput').value.trim();
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const results = document.getElementById('results');
            const searchBtn = document.getElementById('searchBtn');
            const infoText = document.getElementById('infoText');

            if (!busqueda) {
                mostrarError('Por favor, introduce un municipio para buscar');
                return;
            }

            // Limpiar resultados anteriores
            results.innerHTML = '';
            error.style.display = 'none';
            loading.style.display = 'block';
            searchBtn.disabled = true;

            try {
                // Si no tenemos datos cargados, cargarlos
                if (todasLasGasolineras.length === 0) {
                    const response = await fetch(
                        'https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/'
                    );

                    if (!response.ok) {
                        throw new Error('Error al conectar con la API');
                    }

                    const data = await response.json();
                    todasLasGasolineras = data.ListaEESSPrecio || [];
                }

                // Filtrar por municipio
                const gasolinerasFiltradas = todasLasGasolineras.filter(g => 
                    g.Municipio?.toLowerCase().includes(busqueda.toLowerCase()) ||
                    g.Localidad?.toLowerCase().includes(busqueda.toLowerCase())
                );

                if (gasolinerasFiltradas.length === 0) {
                    mostrarError(`No se encontraron gasolineras en "${busqueda}". Intenta con otro municipio.`);
                    return;
                }

                // Ordenar por precio de diesel (m√°s baratas primero)
                const conPrecioDiesel = gasolinerasFiltradas.filter(g => 
                    g['Precio Gasoleo A'] && g['Precio Gasoleo A'] !== ''
                ).sort((a, b) => {
                    const precioA = parseFloat(a['Precio Gasoleo A'].replace(',', '.'));
                    const precioB = parseFloat(b['Precio Gasoleo A'].replace(',', '.'));
                    return precioA - precioB;
                });

                const sinPrecioDiesel = gasolinerasFiltradas.filter(g => 
                    !g['Precio Gasoleo A'] || g['Precio Gasoleo A'] === ''
                );

                const ordenadas = [...conPrecioDiesel, ...sinPrecioDiesel];

                // Mostrar resultados
                mostrarResultados(ordenadas, busqueda);
                infoText.textContent = `${todasLasGasolineras.length.toLocaleString()} gasolineras cargadas`;

            } catch (err) {
                console.error('Error:', err);
                mostrarError('Error al cargar los datos. Verifica tu conexi√≥n a internet e int√©ntalo de nuevo.');
            } finally {
                loading.style.display = 'none';
                searchBtn.disabled = false;
            }
        }

        function mostrarResultados(gasolineras, municipio) {
            const results = document.getElementById('results');
            
            let html = `
                <div class="results-header">
                    <strong>${gasolineras.length}</strong> gasolineras encontradas en <strong>${municipio}</strong>
                </div>
            `;

            gasolineras.forEach(g => {
                const nombre = g.R√≥tulo || 'Sin nombre';
                const direccion = g['Direcci√≥n'] || 'Direcci√≥n no disponible';
                const localidad = g.Localidad || g.Municipio || '';
                const provincia = g.Provincia || '';

                html += `
                    <div class="gas-card">
                        <h3>${nombre}</h3>
                        <p class="gas-address">üìç ${direccion}, ${localidad} (${provincia})</p>
                        
                        <div class="prices-grid">
                            <div class="price-box g95">
                                <div class="price-label">Gasolina 95</div>
                                <div class="price-value">${formatPrecio(g['Precio Gasolina 95 E5'])}</div>
                            </div>
                            <div class="price-box g98">
                                <div class="price-label">Gasolina 98</div>
                                <div class="price-value">${formatPrecio(g['Precio Gasolina 98 E5'])}</div>
                            </div>
                            <div class="price-box diesel">
                                <div class="price-label">Diesel</div>
                                <div class="price-value">${formatPrecio(g['Precio Gasoleo A'])}</div>
                            </div>
                            <div class="price-box diesel-plus">
                                <div class="price-label">Diesel+</div>
                                <div class="price-value">${formatPrecio(g['Precio Gasoleo Premium'])}</div>
                            </div>
                        </div>
                        
                        ${g.Horario ? `<div class="schedule">üïê ${g.Horario}</div>` : ''}
                    </div>
                `;
            });

            results.innerHTML = html;
        }

        function formatPrecio(precio) {
            if (!precio || precio === '') return 'N/D';
            return precio.replace(',', '.') + ' ‚Ç¨';
        }

        function mostrarError(mensaje) {
            const error = document.getElementById('error');
            error.innerHTML = `<div class="error">${mensaje}</div>`;
            error.style.display = 'block';
        }
    </script>
</body>
</html>
